<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#5182BD">
    <title>Finanzas Personales</title>
    
    <!-- Librer√≠as -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Fuente -->
    <link id="fontLink" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #F6E8DD;
            --primary: #5182BD;
            --accent: #DC3C22;
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-light: #718096;
            --success: #10b981;
            --danger: #ef4444;
            --radius: 20px;
            --shadow: 0 4px 15px rgba(0,0,0,0.06);
            --nav-height: 70px;
            --font-family: 'Montserrat', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-family);
            margin: 0; padding: 0; padding-bottom: calc(var(--nav-height) + 20px);
            padding-top: env(safe-area-inset-top); font-size: 16px;
        }

        .container { max-width: 800px; margin: 0 auto; min-height: 100vh; padding: 20px 15px; }
        .screen { display: none; }
        .screen.active { display: block; }

        /* HEADER */
        header {
            background: var(--primary); color: white; padding: 15px 20px;
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 4px 20px rgba(81, 130, 189, 0.3); position: sticky; top: 0; z-index: 50;
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
        .icon-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s; }
        .icon-btn:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }

        /* CARDS */
        .card { background: var(--card-bg); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
        .section-title { font-size: 0.9rem; font-weight: 800; color: var(--primary); margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #f0f0f0; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* SELECTOR FECHA */
        .date-capsule {
            background: white; border: 1px solid rgba(0,0,0,0.05); padding: 12px 20px;
            border-radius: 30px; font-size: 1rem; font-weight: 700; color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; justify-content: flex-start; gap: 15px;
            margin: 0 auto 20px auto; width: 100%; box-shadow: var(--shadow); transition: 0.3s;
        }
        .date-capsule:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .date-capsule i { color: var(--primary); opacity: 0.7; }

        /* TABS */
        .scope-tabs { display: flex; background: #f1f5f9; border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .scope-tab { flex: 1; text-align: center; padding: 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 700; cursor: pointer; color: var(--text-light); transition: 0.2s; }
        .scope-tab.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* NAV GRIDS */
        .block-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
        .time-block { 
            background: white; border: 2px solid #edf2f7; padding: 12px 5px; border-radius: 12px; 
            text-align: center; font-weight: 700; font-size: 0.9rem; cursor: pointer; color: var(--text-light);
            transition: 0.3s;
        }
        .time-block:hover { border-color: var(--primary); background: #f0f7ff; transform: scale(1.05); }
        .time-block.active { border-color: var(--primary); background: var(--primary); color: white; }

        /* CHART */
        .chart-container { position: relative; height: 400px; width: 100%; }

        /* FORM */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .col-full { grid-column: span 2; }
        label { display: block; font-size: 0.75rem; font-weight: 700; margin-bottom: 5px; color: var(--text-light); text-transform: uppercase; }
        .f-input { width: 100%; padding: 12px 15px; border: 2px solid #edf2f7; border-radius: 12px; font-size: 1rem; outline: none; background: #fff; color: var(--text-main); font-family: inherit; transition: 0.3s; }
        .f-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(81, 130, 189, 0.1); }

        /* BOTONES */
        .btn-main { width: 100%; padding: 15px; background: linear-gradient(135deg, var(--accent), #b82d1b); color: white; border: none; border-radius: 15px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(220, 60, 34, 0.3); transition: 0.3s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(220, 60, 34, 0.4); }
        .btn-secondary { background: white; color: var(--primary); border: 2px solid var(--primary); box-shadow: none; padding: 8px 15px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; }
        .btn-secondary:hover { background: var(--primary); color: white; }

        /* LISTA */
        .list-container { max-height: 400px; overflow-y: auto; }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .li-left { display: flex; align-items: center; gap: 12px; flex: 1; }
        .li-icon { width: 40px; height: 40px; background: #f4f4f4; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .li-info { flex: 1; }
        .li-info h4 { margin: 0; font-size: 0.9rem; font-weight: 700; color: var(--text-main); }
        .li-info p { margin: 2px 0 0; font-size: 0.75rem; color: var(--text-light); }
        .li-amount { font-weight: 800; font-size: 0.95rem; text-align: right; margin-right: 10px; }
        .li-delete { color: #ccc; cursor: pointer; padding: 5px; transition: 0.3s; }
        .li-delete:hover { color: var(--danger); transform: scale(1.2); }
        .amt-inc { color: var(--success); } 
        .amt-exp { color: var(--danger); }

        /* BALANCE */
        .balance-row {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #dee2e6;
        }
        .balance-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .balance-label {
            font-weight: 800;
            font-size: 1rem;
            color: var(--text-main);
            text-transform: uppercase;
        }
        .balance-amount {
            font-weight: 800;
            font-size: 1.2rem;
        }
        .balance-positive { color: var(--success); }
        .balance-negative { color: var(--danger); }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: white; width: 100%; max-width: 450px; border-radius: 25px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto; position: relative; }

        /* NAVBAR */
        .bottom-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-radius: 35px; z-index: 100; border: 1px solid rgba(255,255,255,0.5); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #a0aec0; cursor: pointer; width: 33%; transition: 0.3s; font-size: 0.7rem; }
        .nav-item .nav-emoji { font-size: 1.8rem; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item:hover { color: var(--primary); }

        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .settings-row:hover { background: #f9f9f9; padding-left: 10px; }
        
        /* Currency toggle buttons */
        .currency-toggle { display: flex; gap: 5px; }
        .currency-toggle button { padding: 6px 12px; font-size: 0.7rem; }

        /* Credit card section */
        .cc-section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 15px; display: none; }
        .cc-section.active { display: block; }

        /* Theme customizer */
        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .theme-option { padding: 15px; border-radius: 12px; cursor: pointer; border: 2px solid #eee; text-align: center; transition: 0.3s; }
        .theme-option:hover { border-color: var(--primary); transform: scale(1.05); }
        .theme-option.active { border-color: var(--primary); background: var(--primary); color: white; }

        .color-picker-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
        .color-picker-row input[type="color"] { width: 50px; height: 50px; border: none; border-radius: 10px; cursor: pointer; }

        .font-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .font-option { padding: 12px; border: 2px solid #eee; border-radius: 10px; cursor: pointer; text-align: center; transition: 0.3s; }
        .font-option:hover { border-color: var(--primary); }
        .font-option.active { border-color: var(--primary); background: var(--primary); color: white; }

        /* Quick month navigation */
        .quick-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .quick-nav-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.85rem;
        }
        .quick-nav-btn:hover {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>

    <header>
        <h1 data-i18n="app_title">üí∞ FINANZAS</h1>
        <button class="icon-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </header>

    <div class="container">

        <!-- SCREEN 1: INICIO -->
        <div id="screen-home" class="screen active content-area">
            <div class="date-capsule" onclick="openDateSelector('home')">
                <span style="font-size:1.3rem;">üìÖ</span>
                <span id="homeDateDisplay">...</span>
                <i class="fas fa-chevron-down" style="margin-left:auto; font-size:0.8rem; opacity:0.5;"></i>
            </div>

            <!-- Quick navigation -->
            <div class="quick-nav">
                <button class="quick-nav-btn" onclick="changeMonth(-1)">‚¨ÖÔ∏è Mes Anterior</button>
                <button class="quick-nav-btn" onclick="goToCurrentMonth()">üìç Hoy</button>
                <button class="quick-nav-btn" onclick="changeMonth(1)">Mes Siguiente ‚û°Ô∏è</button>
            </div>

            <!-- Resumen Gastos (Pie Chart) -->
            <div class="card">
                <div class="section-title">
                    <span data-i18n="inc_exp_summary">üìä Gastos e Ingresos</span>
                    <div class="currency-toggle">
                        <button class="btn-secondary currency-btn" data-curr="ARS" onclick="setExpenseCurrency('ARS', this)">ARS</button>
                        <button class="btn-secondary currency-btn" data-curr="USD" onclick="setExpenseCurrency('USD', this)">USD</button>
                        <button class="btn-secondary currency-btn" data-curr="BRL" onclick="setExpenseCurrency('BRL', this)">BRL</button>
                    </div>
                </div>
                
                <div class="scope-tabs">
                    <div class="scope-tab active" onclick="setChartScope('month', this)">Mes</div>
                    <div class="scope-tab" onclick="setChartScope('year', this)">A√±o</div>
                    <div class="scope-tab" onclick="setChartScope('all', this)">Total</div>
                </div>

                <div class="chart-container">
                    <canvas id="expensesPieChart"></canvas>
                </div>
                <div id="noDataMsg" style="text-align:center; display:none; color:#999; padding:40px;">Sin datos para mostrar</div>
            </div>

            <!-- Resumen Inversiones -->
            <div class="card">
                <div class="section-title"><span data-i18n="invest_summary">üìà Inversiones</span></div>
                <div style="text-align:center; padding:15px; background:#f8fafc; border-radius:15px;">
                    <div style="font-size:0.8rem; color:#888;">TOTAL ACUMULADO</div>
                    <div style="font-size:1.8rem; font-weight:800; color:var(--primary);" id="totalInvest">0 USD</div>
                </div>
                <div style="height:250px; margin-top:15px;">
                    <canvas id="investPieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: GASTOS -->
        <div id="screen-expenses" class="screen content-area">
            <div class="card" id="expNavCard">
                <div class="section-title"><span>üìÖ Seleccionar Per√≠odo</span></div>
                <div id="expDecadeGrid" class="block-grid"></div>
                <div id="expYearGrid" class="block-grid" style="display:none;"></div>
                <div id="expMonthGrid" class="block-grid" style="display:none;"></div>
            </div>

            <div id="expDashboard" style="display:none;">
                <div class="date-capsule" onclick="resetExpNav()">
                    <i class="fas fa-arrow-left"></i> <span style="font-size:1.3rem;">üìÖ</span> <span id="expCurrentPeriodLabel">...</span>
                </div>
                <button class="btn-main" onclick="openExpenseForm()"><i class="fas fa-plus"></i> ‚ûï Registrar Movimiento</button>
                <div class="card" style="margin-top:20px;">
                    <div class="section-title">üí∏ Movimientos</div>
                    <div id="expensesList" class="list-container"></div>
                    <div id="balanceSection"></div>
                </div>
            </div>
        </div>

        <!-- SCREEN 3: INVERSIONES -->
        <div id="screen-invest" class="screen content-area">
            <div class="card" id="invNavCard">
                <div class="section-title"><span>üìÖ Seleccionar Per√≠odo</span></div>
                <div id="invDecadeGrid" class="block-grid"></div>
                <div id="invYearGrid" class="block-grid" style="display:none;"></div>
                <div id="invMonthGrid" class="block-grid" style="display:none;"></div>
            </div>

            <div id="invDashboard" style="display:none;">
                <div class="date-capsule" onclick="resetInvNav()">
                    <i class="fas fa-arrow-left"></i> <span style="font-size:1.3rem;">üìÖ</span> <span id="invCurrentPeriodLabel">...</span>
                </div>
                
                <div class="card" style="background:#f0f9ff; border:1px solid #bae6fd;">
                    <div class="section-title" style="color:#0369a1; border:none;">üíµ Ahorro Mensual</div>
                    <div class="form-grid">
                        <div><label>ARS</label><input type="number" id="invSavingsARS" class="f-input" onchange="updateSavings('ARS')"></div>
                        <div><label>USD</label><input type="number" id="invSavingsUSD" class="f-input" onchange="updateSavings('USD')"></div>
                    </div>
                </div>

                <button class="btn-main" style="background:var(--primary);" onclick="openInvestModal()"><i class="fas fa-chart-line"></i> üìä Nueva Inversi√≥n</button>
                
                <div class="card" style="margin-top:20px;">
                    <div class="section-title">üíº Operaciones</div>
                    <div id="investmentsList" class="list-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVBAR -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="nav('home', this)">
            <div class="nav-emoji">üè†</div>
            <span data-i18n="nav_home">Inicio</span>
        </div>
        <div class="nav-item" onclick="nav('expenses', this)">
            <div class="nav-emoji">üí≥</div>
            <span data-i18n="nav_expenses">Gastos</span>
        </div>
        <div class="nav-item" onclick="nav('invest', this)">
            <div class="nav-emoji">üê∑</div>
            <span data-i18n="nav_invest">Inversiones</span>
        </div>
    </nav>

    <!-- MODAL GASTO -->
    <div id="addExpenseModal" class="modal-overlay">
        <div class="modal-card">
            <div class="section-title">üìù <span data-i18n="register">Registrar</span> <i class="fas fa-times" onclick="closeExpenseModal()" style="cursor:pointer;"></i></div>
            <div class="form-grid">
                <div class="col-full"><label data-i18n="date">Fecha</label><input type="date" id="expDate" class="f-input"></div>
                <div><label data-i18n="type">Tipo</label><select id="expType" class="f-input"><option value="expense">üí∏ Gasto</option><option value="income">üí∞ Ingreso</option></select></div>
                <div><label data-i18n="amount">Monto</label><input type="number" id="expAmount" class="f-input" placeholder="0"></div>
                <div class="col-full">
                    <label data-i18n="currency">Moneda</label>
                    <select id="expCurrency" class="f-input">
                        <option value="ARS">üá¶üá∑ Pesos</option>
                        <option value="USD">üá∫üá∏ D√≥lares</option>
                        <option value="BRL">üáßüá∑ Reales</option>
                    </select>
                </div>
                <div class="col-full"><label data-i18n="category">Categor√≠a</label><select id="expCategory" class="f-input"></select></div>
                <div class="col-full"><label data-i18n="detail">Detalle</label><input type="text" id="expDesc" class="f-input"></div>
                
                <!-- Credit Card Section -->
                <div class="col-full">
                    <label><input type="checkbox" id="useCreditCard" onchange="toggleCreditCard()"> üí≥ <span data-i18n="use_cc">Pagar con Tarjeta de Cr√©dito</span></label>
                </div>

                <div id="creditCardSection" class="col-full cc-section">
                    <div class="form-grid">
                        <div><label data-i18n="cc_type">Tarjeta</label>
                            <select id="ccType" class="f-input">
                                <option value="visa">üí≥ Visa</option>
                                <option value="mastercard">üí≥ MasterCard</option>
                                <option value="amex">üí≥ American Express</option>
                            </select>
                        </div>
                        <div><label data-i18n="cc_bank">Banco/Billetera</label>
                            <select id="ccBank" class="f-input">
                                <option value="galicia">Galicia</option>
                                <option value="nacion">Naci√≥n</option>
                                <option value="santander">Santander</option>
                                <option value="ciudad">Ciudad</option>
                                <option value="mercadopago">Mercado Pago</option>
                                <option value="bbva">BBVA</option>
                                <option value="hsbc">HSBC</option>
                            </select>
                        </div>
                        <div><label data-i18n="installments">Cuotas</label>
                            <input type="number" id="ccInstallments" class="f-input" value="1" min="1" max="60">
                        </div>
                        <div><label data-i18n="interest">Inter√©s (%)</label>
                            <input type="number" id="ccInterest" class="f-input" value="0" min="0" step="0.01">
                        </div>
                        <div class="col-full"><label data-i18n="cc_closing">Cierre de Tarjeta (d√≠a del mes)</label>
                            <input type="number" id="ccClosing" class="f-input" min="1" max="31" placeholder="Ej: 22">
                        </div>
                    </div>
                </div>

                <div class="col-full"><button class="btn-main" onclick="addExpense()">üíæ <span data-i18n="save">Guardar</span></button></div>
            </div>
        </div>
    </div>

    <!-- MODAL INVERSION -->
    <div id="addInvestModal" class="modal-overlay">
        <div class="modal-card">
            <div class="section-title">üìä <span data-i18n="operation">Operaci√≥n</span> <i class="fas fa-times" onclick="closeInvestModal()" style="cursor:pointer;"></i></div>
            <div class="form-grid">
                <div class="col-full"><label data-i18n="action">Acci√≥n</label><select id="invAction" class="f-input"><option value="subscribe">‚úÖ Suscribir</option><option value="redeem">‚ùå Rescatar</option></select></div>
                <div><label data-i18n="platform">Plataforma</label><select id="invPlat" class="f-input"><option>Galicia</option><option>Santander</option><option>Balanz</option><option>Cocos</option><option>IOL</option></select></div>
                <div><label data-i18n="inv_type">Tipo</label><select id="invType" class="f-input"><option>FCI</option><option>ON</option><option>CEDEAR</option><option>Accion</option><option>Crypto</option></select></div>
                <div class="col-full"><label data-i18n="instrument">Instrumento</label><input type="text" id="invInst" class="f-input" placeholder="Ej: Fima Premium"></div>
                <div><label data-i18n="amount">Monto</label><input type="number" id="invAmt" class="f-input"></div>
                <div><label data-i18n="currency">Moneda</label><select id="invCurr" class="f-input"><option>ARS</option><option>USD</option></select></div>
                <div class="col-full"><button class="btn-main" onclick="saveInvestment()">üíæ <span data-i18n="save">Guardar</span></button></div>
            </div>
        </div>
    </div>

    <!-- MODAL FECHA HOME -->
    <div id="dateSelectorModal" class="modal-overlay">
        <div class="modal-card">
            <div class="section-title">üìÖ <span data-i18n="select_date">Seleccionar Fecha</span></div>
            <div id="homeDecadeGrid" class="block-grid"></div>
            <div id="homeYearGrid" class="block-grid" style="display:none;"></div>
            <div id="homeMonthGrid" class="block-grid" style="display:none;"></div>
            <button class="btn-secondary" style="width:100%; margin-top:15px;" onclick="closeDateSelector()"><span data-i18n="close">Cerrar</span></button>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-card">
            <div class="section-title">‚öôÔ∏è <span data-i18n="settings">Configuraci√≥n</span> <i class="fas fa-times" onclick="closeSettings()" style="cursor:pointer;"></i></div>
            
            <div class="settings-row" onclick="openLanguageModal()">
                <span>üåê <span data-i18n="language">Idioma</span></span>
                <span id="langDisplay">ES</span>
            </div>
            
            <div class="settings-row" onclick="openThemeModal()">
                <span>üé® <span data-i18n="theme">Personalizar Tema</span></span>
                <i class="fas fa-chevron-right"></i>
            </div>
            
            <div class="settings-row" onclick="alert('Ideado por Fernando Fari√±a\nDesarrollado con ‚ù§Ô∏è')">
                <span>‚ÑπÔ∏è About</span>
                <i class="fas fa-info-circle"></i>
            </div>
            
            <button class="btn-main" style="background:var(--danger); margin-top:20px;" onclick="clearAllData()">üóëÔ∏è <span data-i18n="delete_all">Borrar Todo</span></button>
        </div>
    </div>

    <!-- LANGUAGE MODAL -->
    <div id="languageModal" class="modal-overlay">
        <div class="modal-card">
            <div class="section-title">üåê <span data-i18n="select_language">Seleccionar Idioma</span> <i class="fas fa-times" onclick="closeLanguageModal()" style="cursor:pointer;"></i></div>
            <div class="theme-grid">
                <div class="theme-option" onclick="setLanguage('ES')">
                    <div style="font-size:2rem;">üá™üá∏</div>
                    <div style="margin-top:10px; font-weight:700;">Espa√±ol</div>
                </div>
                <div class="theme-option" onclick="setLanguage('EN')">
                    <div style="font-size:2rem;">üá∫üá∏</div>
                    <div style="margin-top:10px; font-weight:700;">English</div>
                </div>
            </div>
        </div>
    </div>

    <!-- THEME CUSTOMIZER MODAL -->
    <div id="themeModal" class="modal-overlay">
        <div class="modal-card">
            <div class="section-title">üé® <span data-i18n="customize_theme">Personalizar Tema</span> <i class="fas fa-times" onclick="closeThemeModal()" style="cursor:pointer;"></i></div>
            
            <h3 style="margin-top:20px; font-size:0.9rem; color:var(--text-light);">COLORES</h3>
            <div class="color-picker-row">
                <span>üé® Color Principal</span>
                <input type="color" id="primaryColor" value="#5182BD" onchange="updateTheme()">
            </div>
            <div class="color-picker-row">
                <span>üî¥ Color Acento</span>
                <input type="color" id="accentColor" value="#DC3C22" onchange="updateTheme()">
            </div>
            <div class="color-picker-row">
                <span>üå∏ Fondo</span>
                <input type="color" id="bgColor" value="#F6E8DD" onchange="updateTheme()">
            </div>

            <h3 style="margin-top:20px; font-size:0.9rem; color:var(--text-light);">FUENTE</h3>
            <div class="font-selector">
                <div class="font-option" data-font="Montserrat" onclick="selectFont(this)" style="font-family:'Montserrat'">Montserrat</div>
                <div class="font-option" data-font="Roboto" onclick="selectFont(this)" style="font-family:'Roboto'">Roboto</div>
                <div class="font-option" data-font="Open Sans" onclick="selectFont(this)" style="font-family:'Open Sans'">Open Sans</div>
                <div class="font-option" data-font="Poppins" onclick="selectFont(this)" style="font-family:'Poppins'">Poppins</div>
                <div class="font-option" data-font="Raleway" onclick="selectFont(this)" style="font-family:'Raleway'">Raleway</div>
                <div class="font-option" data-font="Lato" onclick="selectFont(this)" style="font-family:'Lato'">Lato</div>
            </div>

            <button class="btn-secondary" style="width:100%; margin-top:20px;" onclick="resetTheme()">üîÑ Restablecer por Defecto</button>
        </div>
    </div>

<script>
    // --- TRANSLATIONS ---
    const translations = {
        ES: {
            app_title: "FINANZAS",
            inc_exp_summary: "Gastos e Ingresos",
            invest_summary: "Inversiones",
            nav_home: "Inicio",
            nav_expenses: "Gastos",
            nav_invest: "Inversiones",
            register: "Registrar",
            date: "Fecha",
            type: "Tipo",
            amount: "Monto",
            currency: "Moneda",
            category: "Categor√≠a",
            detail: "Detalle",
            use_cc: "Pagar con Tarjeta de Cr√©dito",
            cc_type: "Tarjeta",
            cc_bank: "Banco/Billetera",
            installments: "Cuotas",
            interest: "Inter√©s (%)",
            cc_closing: "Cierre de Tarjeta (d√≠a del mes)",
            save: "Guardar",
            operation: "Operaci√≥n",
            action: "Acci√≥n",
            platform: "Plataforma",
            inv_type: "Tipo",
            instrument: "Instrumento",
            select_date: "Seleccionar Fecha",
            close: "Cerrar",
            settings: "Configuraci√≥n",
            language: "Idioma",
            theme: "Personalizar Tema",
            delete_all: "Borrar Todo",
            select_language: "Seleccionar Idioma",
            customize_theme: "Personalizar Tema"
        },
        EN: {
            app_title: "FINANCE",
            inc_exp_summary: "Expenses & Income",
            invest_summary: "Investments",
            nav_home: "Home",
            nav_expenses: "Expenses",
            nav_invest: "Investments",
            register: "Register",
            date: "Date",
            type: "Type",
            amount: "Amount",
            currency: "Currency",
            category: "Category",
            detail: "Detail",
            use_cc: "Pay with Credit Card",
            cc_type: "Card",
            cc_bank: "Bank/Wallet",
            installments: "Installments",
            interest: "Interest (%)",
            cc_closing: "Card Closing (day of month)",
            save: "Save",
            operation: "Operation",
            action: "Action",
            platform: "Platform",
            inv_type: "Type",
            instrument: "Instrument",
            select_date: "Select Date",
            close: "Close",
            settings: "Settings",
            language: "Language",
            theme: "Customize Theme",
            delete_all: "Delete All",
            select_language: "Select Language",
            customize_theme: "Customize Theme"
        }
    };

    // --- DATOS ---
    const categories=[
        {id:'super',n:'Supermercado',i:'üõí',c:'#FFB3BA'},{id:'carniceria',n:'Carnicer√≠a',i:'ü•©',c:'#FF9AA2'},{id:'verdu',n:'Verduler√≠a',i:'ü•¶',c:'#B5EAD7'},{id:'house',n:'Alquiler',i:'üè†',c:'#C7CEEA'},{id:'luz',n:'Luz',i:'üí°',c:'#FFFACD'},{id:'gas',n:'Gas',i:'üî•',c:'#FFDFBA'},
        {id:'agua',n:'Agua',i:'üíß',c:'#B0E0E6'},{id:'wifi',n:'Internet',i:'üåê',c:'#D8BFD8'},{id:'cel',n:'Celular',i:'üì±',c:'#E0BBE4'},{id:'food',n:'Comida',i:'üçî',c:'#FFDAB9'},{id:'del',n:'Delivery',i:'üõµ',c:'#FFDEAD'},{id:'trans',n:'Transporte',i:'üöå',c:'#F0E68C'},
        {id:'nafta',n:'Nafta',i:'‚õΩ',c:'#FFA07A'},{id:'taxi',n:'Taxi',i:'üöñ',c:'#FFFFE0'},{id:'med',n:'M√©dico',i:'ü©∫',c:'#B0E0E6'},{id:'farm',n:'Farmacia',i:'üíä',c:'#E6E6FA'},{id:'gym',n:'Gimnasio',i:'üèãÔ∏è',c:'#98FB98'},{id:'ropa',n:'Ropa',i:'üëï',c:'#FFB6C1'},
        {id:'edu',n:'Educaci√≥n',i:'üéì',c:'#B5D8EB'},{id:'salidas',n:'Salidas',i:'üéâ',c:'#E0BBE4'},{id:'cine',n:'Cine',i:'üéüÔ∏è',c:'#DDA0DD'},{id:'stream',n:'Streaming',i:'üì∫',c:'#D8BFD8'},{id:'viaje',n:'Viajes',i:'‚úàÔ∏è',c:'#AFEEEE'},{id:'masc',n:'Mascota',i:'üêæ',c:'#FFDAB9'},
        {id:'tarj',n:'Tarjeta',i:'üí≥',c:'#FFB3BA'},{id:'ahorro',n:'Ahorro',i:'üí∞',c:'#B5EAD7'},{id:'inv',n:'Inversi√≥n',i:'üìà',c:'#B5EAD7'},{id:'sueldo',n:'Sueldo',i:'üíµ',c:'#C7CEEA'},{id:'otros',n:'Otros',i:'‚ùì',c:'#E2F0CB'}
    ];
    const months=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    // --- ESTADO ---
    let transactions = JSON.parse(localStorage.getItem('fp18_trans')) || [];
    let investments = JSON.parse(localStorage.getItem('fp18_inv')) || [];
    let savings = JSON.parse(localStorage.getItem('fp18_sav')) || {};
    let currentLanguage = localStorage.getItem('fp18_lang') || 'ES';
    let theme = JSON.parse(localStorage.getItem('fp18_theme')) || {
        primary: '#5182BD',
        accent: '#DC3C22',
        bg: '#F6E8DD',
        font: 'Montserrat'
    };
    
    // Load saved date or use current
    let savedDate = JSON.parse(localStorage.getItem('fp18_currentDate'));
    let homeDate = savedDate || { year: new Date().getFullYear(), month: new Date().getMonth() };
    let expState = savedDate || { year: new Date().getFullYear(), month: new Date().getMonth() };
    let invState = savedDate || { year: new Date().getFullYear(), month: new Date().getMonth() };
    
    let currentExpenseCurrency = 'ARS';
    let currentChartScope = 'month';
    let currentDollar = 1000;
    let currentReal = 200;
    let expensePieChart = null;
    let pieChart = null;

    // Save current date when it changes
    function saveCurrentDate() {
        localStorage.setItem('fp18_currentDate', JSON.stringify(homeDate));
    }

    // --- INIT ---
    window.onload = function() {
        Chart.register(ChartDataLabels);
        fetch('https://dolarapi.com/v1/dolares/oficial')
            .then(r=>r.json())
            .then(d=>{currentDollar=d.venta; updateHomeUI();})
            .catch(e=>{console.log('Error cargando d√≥lar:', e); updateHomeUI();});
        
        applyTheme();
        applyLanguage();
        populateCats();
        setupNav('exp'); setupNav('inv'); setupNav('home');
        
        updateDateDisplay();
        document.getElementById('expDate').valueAsDate = new Date();
        updateHomeUI();
        highlightActiveCurrency();
    };

    function updateDateDisplay() {
        document.getElementById('homeDateDisplay').innerText = `${months[homeDate.month]} ${homeDate.year}`;
    }

    // Quick navigation functions
    window.changeMonth = function(delta) {
        homeDate.month += delta;
        if(homeDate.month > 11) {
            homeDate.month = 0;
            homeDate.year++;
        } else if(homeDate.month < 0) {
            homeDate.month = 11;
            homeDate.year--;
        }
        expState.month = homeDate.month;
        expState.year = homeDate.year;
        invState.month = homeDate.month;
        invState.year = homeDate.year;
        saveCurrentDate();
        updateDateDisplay();
        updateHomeUI();
    }

    window.goToCurrentMonth = function() {
        const today = new Date();
        homeDate = { year: today.getFullYear(), month: today.getMonth() };
        expState = { year: today.getFullYear(), month: today.getMonth() };
        invState = { year: today.getFullYear(), month: today.getMonth() };
        saveCurrentDate();
        updateDateDisplay();
        updateHomeUI();
    }

    // --- THEME & LANGUAGE ---
    function applyTheme() {
        document.documentElement.style.setProperty('--primary', theme.primary);
        document.documentElement.style.setProperty('--accent', theme.accent);
        document.documentElement.style.setProperty('--bg-body', theme.bg);
        document.documentElement.style.setProperty('--font-family', theme.font);
        
        const fontLink = document.getElementById('fontLink');
        fontLink.href = `https://fonts.googleapis.com/css2?family=${theme.font.replace(' ','+')}:wght@400;500;600;700;800&display=swap`;
        
        document.getElementById('primaryColor').value = theme.primary;
        document.getElementById('accentColor').value = theme.accent;
        document.getElementById('bgColor').value = theme.bg;
        
        document.querySelectorAll('.font-option').forEach(opt => {
            opt.classList.toggle('active', opt.dataset.font === theme.font);
        });
    }

    function updateTheme() {
        theme.primary = document.getElementById('primaryColor').value;
        theme.accent = document.getElementById('accentColor').value;
        theme.bg = document.getElementById('bgColor').value;
        localStorage.setItem('fp18_theme', JSON.stringify(theme));
        applyTheme();
    }

    function selectFont(elem) {
        document.querySelectorAll('.font-option').forEach(e => e.classList.remove('active'));
        elem.classList.add('active');
        theme.font = elem.dataset.font;
        localStorage.setItem('fp18_theme', JSON.stringify(theme));
        applyTheme();
    }

    function resetTheme() {
        theme = { primary: '#5182BD', accent: '#DC3C22', bg: '#F6E8DD', font: 'Montserrat' };
        localStorage.setItem('fp18_theme', JSON.stringify(theme));
        applyTheme();
    }

    function applyLanguage() {
        document.getElementById('langDisplay').innerText = currentLanguage;
        document.querySelectorAll('[data-i18n]').forEach(elem => {
            const key = elem.getAttribute('data-i18n');
            if(translations[currentLanguage][key]) {
                elem.innerText = translations[currentLanguage][key];
            }
        });
    }

    function setLanguage(lang) {
        currentLanguage = lang;
        localStorage.setItem('fp18_lang', lang);
        applyLanguage();
        closeLanguageModal();
    }

    window.openLanguageModal = function() { document.getElementById('languageModal').style.display='flex'; }
    window.closeLanguageModal = function() { document.getElementById('languageModal').style.display='none'; }
    window.openThemeModal = function() { document.getElementById('themeModal').style.display='flex'; }
    window.closeThemeModal = function() { document.getElementById('themeModal').style.display='none'; }

    // --- CREDIT CARD ---
    window.toggleCreditCard = function() {
        const checked = document.getElementById('useCreditCard').checked;
        document.getElementById('creditCardSection').classList.toggle('active', checked);
    }

    function calculateInstallments(amount, installments, interestRate, closingDay, purchaseDate) {
        const results = [];
        const monthlyInterest = interestRate / 100;
        
        let installmentAmount;
        if(interestRate === 0) {
            installmentAmount = amount / installments;
        } else {
            const factor = Math.pow(1 + monthlyInterest, installments);
            installmentAmount = amount * (monthlyInterest * factor) / (factor - 1);
        }

        const purchase = new Date(purchaseDate);
        const purchaseDay = purchase.getDate();
        const purchaseMonth = purchase.getMonth();
        const purchaseYear = purchase.getFullYear();
        
        // Determine first payment date
        let firstPaymentMonth, firstPaymentYear;
        
        // If purchase is AFTER closing day, it goes to NEXT MONTH's statement
        // Payment is made in the month AFTER that
        if(purchaseDay > closingDay) {
            // Purchase after closing ‚Üí goes to next month's statement ‚Üí pay in 2 months
            firstPaymentMonth = purchaseMonth + 2;
            firstPaymentYear = purchaseYear;
        } else {
            // Purchase before/on closing ‚Üí goes to current month's statement ‚Üí pay next month
            firstPaymentMonth = purchaseMonth + 1;
            firstPaymentYear = purchaseYear;
        }
        
        // Handle year overflow
        if(firstPaymentMonth > 11) {
            firstPaymentYear += Math.floor(firstPaymentMonth / 12);
            firstPaymentMonth = firstPaymentMonth % 12;
        }
        
        // Create payment dates for each installment
        for(let i = 0; i < installments; i++) {
            let paymentMonth = firstPaymentMonth + i;
            let paymentYear = firstPaymentYear;
            
            // Handle year overflow
            if(paymentMonth > 11) {
                paymentYear += Math.floor(paymentMonth / 12);
                paymentMonth = paymentMonth % 12;
            }
            
            // Create date object for this installment
            // Use day 10 as typical payment due date
            const paymentDate = new Date(paymentYear, paymentMonth, 10);
            
            results.push({
                date: paymentDate,
                amount: installmentAmount,
                installmentNumber: i + 1
            });
        }

        return results;
    }

    // --- HOME DASHBOARD ---
    window.updateHomeUI = function() {
        renderExpensesPieChart();
        renderInvestPieChart();
    };

    window.setExpenseCurrency = function(curr, btn) {
        currentExpenseCurrency = curr;
        document.querySelectorAll('.currency-btn').forEach(b => {
            b.style.background = 'white';
            b.style.color = 'var(--primary)';
        });
        btn.style.background = 'var(--primary)';
        btn.style.color = 'white';
        updateHomeUI();
    }

    function highlightActiveCurrency() {
        document.querySelectorAll('.currency-btn').forEach(b => {
            if(b.dataset.curr === currentExpenseCurrency) {
                b.style.background = 'var(--primary)';
                b.style.color = 'white';
            }
        });
    }

    window.setChartScope = function(scope, btn) {
        currentChartScope = scope;
        document.querySelectorAll('.scope-tab').forEach(t=>t.classList.remove('active'));
        btn.classList.add('active');
        updateHomeUI();
    }

    function renderExpensesPieChart() {
        const y = homeDate.year, m = homeDate.month;
        let data = transactions.filter(t => (t.curr || 'ARS') === currentExpenseCurrency);

        if(currentChartScope === 'month') data = data.filter(t => t.year === y && t.month === m);
        if(currentChartScope === 'year') data = data.filter(t => t.year === y);

        const expenses = data.filter(t => t.type === 'expense');
        const totals = {};
        expenses.forEach(t => { totals[t.cat] = (totals[t.cat]||0) + t.amount; });

        const keys = Object.keys(totals).sort((a,b) => totals[b] - totals[a]);
        const labels = keys.map(k => {
            const c = categories.find(x => x.id === k) || {n:'?', i:''};
            return `${c.i} ${c.n}`;
        });
        const vals = keys.map(k => totals[k]);
        const colors = keys.map(k => {
            const c = categories.find(x => x.id === k) || {c:'#E2F0CB'};
            return c.c;
        });

        const ctx = document.getElementById('expensesPieChart').getContext('2d');
        if(expensePieChart) expensePieChart.destroy();

        if(vals.length === 0) {
            document.getElementById('noDataMsg').style.display = 'block';
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        } else {
            document.getElementById('noDataMsg').style.display = 'none';
        }

        const totalExp = vals.reduce((a,b)=>a+b,0);

        expensePieChart = new Chart(ctx, {
            type: 'doughnut',
            data: { 
                labels: labels, 
                datasets: [{ 
                    data: vals, 
                    backgroundColor: colors,
                    borderWidth: 3,
                    borderColor: '#ffffff'
                }] 
            },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                cutout: '60%',
                layout: { padding: 15 },
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: { 
                            boxWidth: 12,
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    datalabels: {
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (val) => {
                            const pct = Math.round((val/totalExp)*100);
                            return pct > 5 ? pct + '%' : '';
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const pct = Math.round((value/totalExp)*100);
                                return `${label}: $${value.toLocaleString()} (${pct}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderInvestPieChart() {
        let totalUSD = 0, totalARS = 0;
        const typeTotals = {};

        investments.forEach(i => {
            const v = i.amount * (i.action === 'subscribe' ? 1 : -1);
            if(i.curr === 'USD') totalUSD += v; else totalARS += v;
            
            const vUSD = i.curr === 'USD' ? v : v/currentDollar;
            if(!typeTotals[i.type]) typeTotals[i.type] = 0;
            typeTotals[i.type] += vUSD;
        });

        Object.values(savings).forEach(s => {
            totalARS += (s.ARS || 0); totalUSD += (s.USD || 0);
            if(s.ARS > 0 || s.USD > 0) {
                if(!typeTotals['Efectivo']) typeTotals['Efectivo'] = 0;
                typeTotals['Efectivo'] += (s.USD || 0) + ((s.ARS||0)/currentDollar);
            }
        });

        const grandTotal = totalUSD + (totalARS / currentDollar);
        document.getElementById('totalInvest').innerText = `$${Math.round(grandTotal).toLocaleString()} USD`;

        const ctx = document.getElementById('investPieChart').getContext('2d');
        if(pieChart) pieChart.destroy();
        
        const labels = Object.keys(typeTotals);
        const data = Object.values(typeTotals);
        
        if(data.length === 0 || data.every(x=>x<=0)) {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            return;
        }

        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: { 
                labels: labels, 
                datasets: [{ 
                    data: data, 
                    backgroundColor: ['#B5D8EB','#FFB6C1','#FFFACD','#B0E0E6','#E0BBE4','#98FB98'], 
                    borderWidth: 3,
                    borderColor: '#ffffff'
                }] 
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '70%',
                layout: { padding: 20 },
                plugins: { 
                    legend: { 
                        position: 'right', 
                        labels: { boxWidth: 10 } 
                    }, 
                    datalabels: { display: false } 
                }
            }
        });
    }

    // --- TRANSACTIONS ---
    window.openExpenseForm = function() { 
        document.getElementById('addExpenseModal').style.display='flex'; 
        document.getElementById('expDate').valueAsDate = new Date(); 
        document.getElementById('useCreditCard').checked = false;
        toggleCreditCard();
    };
    window.closeExpenseModal = function() { document.getElementById('addExpenseModal').style.display='none'; };
    
    window.addExpense = function() {
        const dStr = document.getElementById('expDate').value;
        const amt = parseFloat(document.getElementById('expAmount').value);
        if(!dStr || !amt) return alert("Faltan datos");
        
        const type = document.getElementById('expType').value;
        const curr = document.getElementById('expCurrency').value;
        const cat = document.getElementById('expCategory').value;
        const desc = document.getElementById('expDesc').value;
        const useCreditCard = document.getElementById('useCreditCard').checked;

        const parts = dStr.split('-');

        if(useCreditCard && type === 'expense') {
            const installments = parseInt(document.getElementById('ccInstallments').value) || 1;
            const interest = parseFloat(document.getElementById('ccInterest').value) || 0;
            const closing = parseInt(document.getElementById('ccClosing').value);
            const ccType = document.getElementById('ccType').value;
            const ccBank = document.getElementById('ccBank').value;

            if(!closing || closing < 1 || closing > 31) {
                return alert("Por favor ingresa el d√≠a de cierre de la tarjeta (1-31)");
            }

            const installmentDates = calculateInstallments(amt, installments, interest, closing, dStr);

            installmentDates.forEach((inst, idx) => {
                const instDate = inst.date;
                const instDateStr = instDate.toISOString().split('T')[0];
                const instParts = instDateStr.split('-');
                
                transactions.push({
                    id: Date.now() + idx,
                    date: instDateStr,
                    year: parseInt(instParts[0]),
                    month: parseInt(instParts[1]) - 1,
                    type: type,
                    amount: inst.amount,
                    curr: curr,
                    cat: cat,
                    desc: `${desc} (${inst.installmentNumber}/${installments}) - ${ccType.toUpperCase()} ${ccBank}`,
                    creditCard: {
                        type: ccType,
                        bank: ccBank,
                        installment: inst.installmentNumber,
                        totalInstallments: installments,
                        interest: interest
                    }
                });
            });

            // Update current date to match the transaction
            homeDate.year = parseInt(parts[0]);
            homeDate.month = parseInt(parts[1]) - 1;
            expState = {...homeDate};
            invState = {...homeDate};
            saveCurrentDate();
            updateDateDisplay();

        } else {
            transactions.push({
                id: Date.now(),
                date: dStr,
                year: parseInt(parts[0]),
                month: parseInt(parts[1]) - 1,
                type: type,
                amount: amt,
                curr: curr,
                cat: cat,
                desc: desc || type
            });

            // Update current date to match the transaction
            homeDate.year = parseInt(parts[0]);
            homeDate.month = parseInt(parts[1]) - 1;
            expState = {...homeDate};
            invState = {...homeDate};
            saveCurrentDate();
            updateDateDisplay();
        }
        
        localStorage.setItem('fp18_trans', JSON.stringify(transactions));
        closeExpenseModal();
        renderExpensesList();
        updateHomeUI();
    };

    window.delTrans = function(id) {
        if(confirm('¬øBorrar?')) {
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem('fp18_trans', JSON.stringify(transactions));
            renderExpensesList();
            updateHomeUI();
        }
    };

    function renderExpensesList() {
        const list = document.getElementById('expensesList');
        const balanceSection = document.getElementById('balanceSection');
        list.innerHTML = '';
        const d = transactions.filter(t => t.year === expState.year && t.month === expState.month);
        
        if(d.length === 0) {
            list.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">Sin registros</div>';
            balanceSection.innerHTML = '';
            return;
        }
        
        // Calculate totals
        let totalIncome = 0;
        let totalExpense = 0;
        
        d.forEach(t => {
            const c = categories.find(x => x.id === t.cat) || {i:'?'};
            list.innerHTML += `
            <div class="list-item">
                <div class="li-left">
                    <div class="li-icon">${c.i}</div>
                    <div class="li-info">
                        <h4>${t.desc}</h4>
                        <p>${t.date}</p>
                    </div>
                </div>
                <div style="display:flex;align-items:center;">
                    <div class="li-amount ${t.type==='income'?'amt-inc':'amt-exp'}">${t.type==='income'?'+':'-'}$${t.amount.toLocaleString()} ${t.curr}</div>
                    <i class="fas fa-times li-delete" onclick="delTrans(${t.id})"></i>
                </div>
            </div>`;
            
            if(t.type === 'income') {
                totalIncome += t.amount;
            } else {
                totalExpense += t.amount;
            }
        });

        // Add balance row
        const balance = totalIncome - totalExpense;
        const balanceClass = balance >= 0 ? 'balance-positive' : 'balance-negative';
        const balanceIcon = balance >= 0 ? 'üìà' : 'üìâ';
        
        balanceSection.innerHTML = `
            <div class="balance-row">
                <div class="balance-content">
                    <span class="balance-label">${balanceIcon} Balance del Mes</span>
                    <span class="balance-amount ${balanceClass}">${balance >= 0 ? '+' : ''}$${balance.toLocaleString()}</span>
                </div>
                <div style="margin-top:10px; font-size:0.8rem; color:#6c757d;">
                    <div>Ingresos: <span style="color:var(--success);font-weight:700;">+$${totalIncome.toLocaleString()}</span></div>
                    <div>Gastos: <span style="color:var(--danger);font-weight:700;">-$${totalExpense.toLocaleString()}</span></div>
                </div>
            </div>
        `;
    }

    // --- INVERSIONES ---
    window.openInvestModal = function() { document.getElementById('addInvestModal').style.display='flex'; };
    window.closeInvestModal = function() { document.getElementById('addInvestModal').style.display='none'; };
    
    window.saveInvestment = function() {
        const inst = document.getElementById('invInst').value;
        const amt = parseFloat(document.getElementById('invAmt').value);
        if(!inst || !amt) return alert("Faltan datos");
        
        investments.push({
            id: Date.now(),
            year: invState.year, month: invState.month,
            action: document.getElementById('invAction').value,
            platform: document.getElementById('invPlat').value,
            type: document.getElementById('invType').value,
            instrument: inst, amount: amt, 
            curr: document.getElementById('invCurr').value
        });
        localStorage.setItem('fp18_inv', JSON.stringify(investments));
        closeInvestModal(); renderInvestmentsList(); updateHomeUI();
    };

    window.delInv = function(id) {
        if(confirm('¬øBorrar?')) {
            investments = investments.filter(t => t.id !== id);
            localStorage.setItem('fp18_inv', JSON.stringify(investments));
            renderInvestmentsList();
            updateHomeUI();
        }
    };

    function renderInvestmentsList() {
        const list = document.getElementById('investmentsList');
        list.innerHTML = '';
        const d = investments.filter(i => i.year === invState.year && i.month === invState.month);
        
        if(d.length === 0) list.innerHTML = '<div style="text-align:center;color:#ccc;padding:20px;">Sin operaciones</div>';
        
        d.forEach(i => {
            const isSub = i.action === 'subscribe';
            list.innerHTML += `
            <div class="list-item">
                <div class="li-left"><div class="li-icon" style="font-size:1rem;color:${isSub?'var(--success)':'var(--danger)'}">${isSub?'‚úÖ':'‚ùå'}</div><div class="li-info"><h4>${i.instrument}</h4><p>${i.type} ‚Ä¢ ${i.platform}</p></div></div>
                <div style="display:flex;align-items:center;">
                    <div class="li-amount">${i.amount.toLocaleString()} ${i.curr}</div>
                    <i class="fas fa-times li-delete" onclick="delInv(${i.id})"></i>
                </div>
            </div>`;
        });
        
        const k = `${invState.year}-${invState.month}`;
        const s = savings[k] || {ARS:'', USD:''};
        document.getElementById('invSavingsARS').value = s.ARS;
        document.getElementById('invSavingsUSD').value = s.USD;
    }

    window.updateSavings = function(curr) {
        const val = parseFloat(document.getElementById(`invSavings${curr}`).value) || 0;
        const k = `${invState.year}-${invState.month}`;
        if(!savings[k]) savings[k] = {ARS:0, USD:0};
        savings[k][curr] = val;
        localStorage.setItem('fp18_sav', JSON.stringify(savings));
        updateHomeUI();
    }

    // --- NAVIGATION ---
    window.nav = function(screen, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-'+screen).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    };

    function setupNav(prefix) {
        const g = document.getElementById(prefix+'DecadeGrid');
        if(!g) return;
        g.innerHTML = '';
        for(let d=2010; d<=2090; d+=10) {
            let b = document.createElement('div'); b.className='time-block'; b.innerText=`${d}-${d+9}`;
            b.onclick = () => showYears(prefix, d);
            g.appendChild(b);
        }
    }
    
    function showYears(prefix, d) {
        document.getElementById(prefix+'DecadeGrid').style.display='none';
        const g = document.getElementById(prefix+'YearGrid'); g.style.display='grid'; g.innerHTML='';
        let bk = document.createElement('div'); bk.className='time-block'; bk.innerHTML='<i class="fas fa-arrow-left"></i>'; bk.style.background='#eee'; 
        bk.onclick = () => resetNavUI(prefix); 
        g.appendChild(bk);
        for(let y=d; y<d+10; y++) {
            let b = document.createElement('div'); b.className='time-block'; b.innerText=y;
            b.onclick = () => showMonths(prefix, y);
            g.appendChild(b);
        }
    }

    function showMonths(prefix, y) {
        if(prefix==='exp') expState.year=y; 
        else if(prefix==='inv') invState.year=y; 
        else homeDate.year=y;
        
        document.getElementById(prefix+'YearGrid').style.display='none';
        const g = document.getElementById(prefix+'MonthGrid'); g.style.display='grid'; g.innerHTML='';
        let bk = document.createElement('div'); bk.className='time-block'; bk.innerHTML='<i class="fas fa-arrow-left"></i>'; bk.style.background='#eee'; 
        bk.onclick = () => resetNavUI(prefix); 
        g.appendChild(bk);
        months.forEach((m, idx) => {
            let b = document.createElement('div'); b.className='time-block'; b.innerText=m;
            b.onclick = () => selectMonth(prefix, idx);
            g.appendChild(b);
        });
    }

    function selectMonth(prefix, i) {
        if(prefix==='exp') expState.month=i; 
        else if(prefix==='inv') invState.month=i; 
        else homeDate.month=i;
        
        if(prefix==='home') {
            saveCurrentDate();
            updateDateDisplay();
            document.getElementById('dateSelectorModal').style.display = 'none';
            updateHomeUI();
        } else {
            document.getElementById(prefix+'NavCard').style.display = 'none';
            document.getElementById(prefix+'Dashboard').style.display = 'block';
            document.getElementById(prefix+'CurrentPeriodLabel').innerText = `${months[i]} ${prefix==='exp'?expState.year:invState.year}`;
            if(prefix==='exp') {
                const mStr = String(i+1).padStart(2,'0');
                document.getElementById('expDate').value = `${expState.year}-${mStr}-01`;
                renderExpensesList();
            } else {
                renderInvestmentsList();
            }
        }
    }

    function resetNavUI(prefix) {
        document.getElementById(prefix+'DecadeGrid').style.display='grid';
        document.getElementById(prefix+'YearGrid').style.display='none';
        document.getElementById(prefix+'MonthGrid').style.display='none';
    }

    window.resetExpNav = function() {
        document.getElementById('expDashboard').style.display='none';
        document.getElementById('expNavCard').style.display='block';
        resetNavUI('exp');
    }
    window.resetInvNav = function() {
        document.getElementById('invDashboard').style.display='none';
        document.getElementById('invNavCard').style.display='block';
        resetNavUI('inv');
    }

    window.openDateSelector = function(ctx) {
        const m = document.getElementById('dateSelectorModal');
        resetNavUI('home'); 
        m.style.display = 'flex';
    }
    window.closeDateSelector = function() { document.getElementById('dateSelectorModal').style.display='none'; }
    
    window.openSettings = function() { document.getElementById('settingsModal').style.display='flex'; }
    window.closeSettings = function() { document.getElementById('settingsModal').style.display='none'; }
    window.clearAllData = function() { 
        if(confirm('¬øSeguro que deseas borrar todos los datos?')) { 
            localStorage.clear(); 
            location.reload(); 
        } 
    }
    
    function populateCats() { 
        const s=document.getElementById('expCategory'); 
        categories.forEach(c=>{
            let o=document.createElement('option');
            o.value=c.id;
            o.innerText=`${c.i} ${c.n}`;
            s.appendChild(o)
        }); 
    }
    
    window.onclick = function(e) { 
        if(e.target.classList.contains('modal-overlay')) e.target.style.display='none'; 
    }

</script>
</body>
</html>